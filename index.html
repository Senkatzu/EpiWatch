<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EpiWatch - Secure System v7</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- CORE STYLES --- */
        :root {
            --primary: #1e3a8a; --secondary: #3b82f6; --danger: #dc2626; 
            --warning: #f59e0b; --success: #10b981; --dark: #0f172a; --light: #f1f5f9;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        
        body { height: 100vh; background-color: var(--light); overflow: hidden; }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 12px;
            width: 350px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .login-box h2 { color: var(--primary); margin-bottom: 5px; }
        .login-box p { color: #64748b; font-size: 13px; margin-bottom: 25px; }
        
        /* --- MAIN APP CONTAINER --- */
        #app-container { display: none; height: 100%; width: 100%; }

        /* --- SIDEBAR --- */
        .sidebar { width: 240px; background: var(--dark); color: white; display: flex; flex-direction: column; flex-shrink: 0; height: 100%; }
        .brand { padding: 20px; font-size: 20px; font-weight: bold; color: var(--secondary); border-bottom: 1px solid #334155; }
        .nav-item { padding: 15px 20px; cursor: pointer; color: #94a3b8; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: #1e293b; color: white; border-left: 4px solid var(--secondary); }
        
        /* Logout Button pushed to bottom */
        .mt-auto { margin-top: auto; border-top: 1px solid #334155; }
        .nav-item.logout:hover { background: #7f1d1d; color: white; border-left: 4px solid #ef4444; }

        /* --- MAIN LAYOUT --- */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; height: 100%; }
        .header { height: 60px; background: white; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; flex-shrink: 0; }
        .content-area { flex: 1; position: relative; overflow: hidden; padding: 20px; }
        
        /* PAGES */
        .page { display: none; height: 100%; flex-direction: column; gap: 20px; }
        .page.active { display: flex; }

        /* --- DASHBOARD CARDS --- */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; flex-shrink: 0; }
        .card { 
            background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            transition: transform 0.2s; position: relative; overflow: hidden;
        }
        .card:hover { transform: translateY(-3px); }
        .card .val { font-size: 28px; font-weight: 800; color: var(--primary); margin: 5px 0; }
        .card .sub { font-size: 12px; color: #64748b; }

        .card.alert-zone { border: 2px solid var(--danger); background: #fef2f2; }
        .blink { animation: blinker 1.5s linear infinite; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; display: inline-block; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        .zone-list { font-size: 14px; font-weight: bold; color: #7f1d1d; margin-bottom: 10px; min-height: 20px; }
        .btn-view-map { width: 100%; background: var(--danger); color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; }

        /* --- LAYOUTS --- */
        .dashboard-split { flex: 1; display: grid; grid-template-columns: 2fr 1fr; gap: 20px; min-height: 0; }
        .panel { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        .reports-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: 100%; }

        .panel-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .btn-mini { padding: 5px 10px; font-size: 11px; border: 1px solid #cbd5e1; background: white; border-radius: 4px; cursor: pointer; color: #334155; margin-left: 5px; transition: 0.2s; }
        .btn-mini:hover { background: #f1f5f9; border-color: var(--secondary); color: var(--secondary); }

        /* --- INPUTS --- */
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: #64748b; margin-bottom: 5px; }
        .form-input, .form-select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; }
        .btn-submit { width: 100%; background: var(--secondary); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-submit:hover { background: #1e40af; }
        
        .table-wrapper { flex: 1; overflow-y: auto; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th { position: sticky; top: 0; background: #f8fafc; text-align: left; padding: 12px; border-bottom: 2px solid #e2e8f0; }
        .data-table td { padding: 12px; border-bottom: 1px solid #eee; }
        
        .badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .badge.critical { background: #fee2e2; color: #991b1b; }
        .badge.stable { background: #ffedd5; color: #9a3412; }
        .badge.recovered { background: #dcfce7; color: #166534; }
        .btn-edit { background: #e2e8f0; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }

        .map-legend { position: absolute; bottom: 20px; right: 20px; background: white; padding: 10px; border-radius: 8px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 12px; }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>ü©∫ EpiWatch</h2>
            <p>Secure Surveillance System</p>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="login-user" class="form-input" placeholder="username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="login-pass" class="form-input" placeholder="password" required>
                </div>
                <button type="submit" class="btn-submit">üîí Secure Login</button>
            </form>
            <div id="login-error" style="color:red; font-size:12px; margin-top:10px; display:none;">Invalid Credentials!</div>
        </div>
    </div>

    <div id="app-container">
        <nav class="sidebar">
            <div class="brand">ü©∫ EpiWatch</div>
            <div class="nav-item active" onclick="showPage('dashboard', this)">üìä Dashboard</div>
            <div class="nav-item" onclick="showPage('map', this)">üåç Live Map</div>
            <div class="nav-item" onclick="showPage('reports', this)">üìù Reports & Entry</div>
            
            <div class="nav-item logout mt-auto" onclick="handleLogout()">üö™ Log Out</div>
        </nav>

        <main class="main">
            <header class="header">
                <h2 id="page-title">Surveillance Dashboard</h2>
                <div style="font-size: 13px; color: #64748b;">User: <strong id="user-display">Admin</strong></div>
            </header>

            <div class="content-area">
                
                <div id="dashboard" class="page active">
                    <div class="stats-row">
                        <div class="card">
                            <h3>Active Cases</h3>
                            <div class="val" id="disp-active">0</div>
                            <div class="sub">Currently Sick</div>
                        </div>
                        
                        <div class="card alert-zone">
                            <h3><span class="blink"></span> Critical Zones</h3>
                            <div class="sub" style="margin-bottom:5px;">Red Alert Areas:</div>
                            <div class="zone-list" id="zone-list">None detected</div>
                            <button class="btn-view-map" onclick="showPage('map')">üìç View Live Map</button>
                        </div>

                        <div class="card">
                            <h3>Total Cases (All Time)</h3>
                            <div class="val" style="color:var(--success)" id="disp-total">0</div>
                            <div class="sub">Total Recorded</div>
                        </div>
                    </div>

                    <div class="dashboard-split">
                        <div class="panel">
                            <div class="panel-header">
                                <span>Monthly Trend</span>
                                <div>
                                    <button class="btn-mini" onclick="downloadChartImage()">üì∑ Save Chart</button>
                                    <button class="btn-mini" onclick="downloadCSV()">üìä Export Excel</button>
                                </div>
                            </div>
                            <div style="flex:1; position:relative; background: white;"><canvas id="trendChart"></canvas></div>
                        </div>
                        <div class="panel">
                            <div class="panel-header">System Logs</div>
                            <div id="feed-list" style="overflow-y:auto; font-size:13px; color:#64748b;">
                                <div style="padding:8px 0; border-bottom:1px solid #eee;">System Online - Waiting for data...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="map" class="page" style="padding:0; position: relative;">
                    <div id="map-container" style="height: 100%; width: 100%;"></div>
                    <div class="map-legend">
                        <div><span class="dot" style="background:red"></span>Critical (Hospitalized)</div>
                        <div><span class="dot" style="background:orange"></span>Stable (Home)</div>
                        <div><span class="dot" style="background:green"></span>Recovered</div>
                    </div>
                </div>

                <div id="reports" class="page">
                    <div class="reports-layout">
                        <div class="panel">
                            <div class="panel-header">üìù Submit Report</div>
                            <form onsubmit="submitReport(event)">
                                <div class="form-group">
                                    <label class="form-label">Date</label>
                                    <input type="date" id="r-date" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Patient Name</label>
                                    <input type="text" id="r-name" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Location</label>
                                    <select id="r-loc" class="form-select">
                                        <option value="Guadalupe">Guadalupe</option>
                                        <option value="Lahug">Lahug</option>
                                        <option value="Mandaue">Mandaue Centro</option>
                                        <option value="Labangon">Labangon</option>
                                        <option value="Tagbilaran City">Tagbilaran City</option>
                                        <option value="Dauis">Dauis</option>
                                        <option value="Panglao">Panglao</option>
                                        <option value="Tubigon">Tubigon</option>
                                        <option value="Clarin">Clarin</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Diagnosis</label>
                                    <select id="r-diag" class="form-select">
                                        <option value="Dengue">Dengue</option>
                                        <option value="Cholera">Cholera</option>
                                        <option value="Typhoid">Typhoid</option>
                                        <option value="Influenza">Influenza</option>
                                        <option value="COVID-19">High Flu</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select id="r-status" class="form-select">
                                        <option value="Critical">üî¥ Critical (Hospitalized)</option>
                                        <option value="Stable">üü† Stable (Home Quarantine)</option>
                                        <option value="Recovered">üü¢ Recovered</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn-submit">Save Record</button>
                            </form>
                        </div>

                        <div class="panel">
                            <div class="panel-header">üìÇ Case Database</div>
                            <div class="table-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Name</th>
                                            <th>Location</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const locationCoords = {
            'Guadalupe': [10.3157, 123.8854],
            'Lahug': [10.3333, 123.8967],
            'Mandaue': [10.3236, 123.9419],
            'Labangon': [10.2974, 123.8824],
            'Tagbilaran City': [9.6500, 123.8500],
            'Dauis': [9.6167, 123.8333],
            'Panglao': [9.5736, 123.7494],
            'Tubigon': [10.0500, 124.1167],
            'Clarin': [10.0833, 124.2167]
        };

        // --- 2. STATE ---
        let reportList = JSON.parse(localStorage.getItem('epiReports_v4')) || []; 
        let map;
        let mapMarkers = [];
        let trendChart;

        // --- 3. LOGIN / LOGOUT LOGIC ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;

            // Simple Hardcoded Credential Check
            if (u === 'maui wowie' && p === 'honolulu123') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                document.getElementById('user-display').innerText = u;
                
                // Initialize App
                initApp();
            } else {
                const err = document.getElementById('login-error');
                err.style.display = 'block';
                err.innerText = "‚ùå Incorrect Username or Password";
            }
        }

        function handleLogout() {
            if(confirm("Are you sure you want to log out?")) {
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('login-user').value = '';
                document.getElementById('login-pass').value = '';
                document.getElementById('login-error').style.display = 'none';
            }
        }

        // --- 4. APP INITIALIZATION ---
        function initApp() {
            document.getElementById('r-date').valueAsDate = new Date();
            // Need to resize map because it was hidden
            setTimeout(() => {
                if(!map) initMap();
                else map.invalidateSize();
                refreshUI();
            }, 100);
        }

        // --- 5. NAVIGATION ---
        function showPage(pageId, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => {
                if(!n.classList.contains('logout')) n.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            
            if(btn) btn.classList.add('active');
            else if(pageId === 'map') document.querySelectorAll('.nav-item')[1].classList.add('active');

            if(pageId === 'map') setTimeout(() => { if(map) map.invalidateSize(); }, 100);
        }

        // --- 6. CORE LOGIC (Map, Data, Charts) ---
        function initMap() {
            map = L.map('map-container').setView([10.0000, 124.0000], 10); // Center slightly to show Cebu & Bohol
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        function refreshUI() {
            renderTable();
            updateDashboard();
            updateMapMarkers();
        }

        function updateMapMarkers() {
            if(!map) return;
            mapMarkers.forEach(marker => map.removeLayer(marker));
            mapMarkers = [];

            reportList.forEach(report => {
                const coords = locationCoords[report.loc];
                if(coords) {
                    let color = 'green';
                    let radius = 100;
                    const lat = coords[0] + (Math.random() - 0.5) * 0.005;
                    const lng = coords[1] + (Math.random() - 0.5) * 0.005;

                    if(report.status === 'Critical') { color = 'red'; radius = 200; }
                    else if (report.status === 'Stable') { color = 'orange'; radius = 150; }

                    const circle = L.circle([lat, lng], {
                        color: color, fillColor: color, fillOpacity: 0.5, radius: radius
                    }).addTo(map);
                    
                    circle.bindPopup(`<b>${report.name}</b><br>Status: ${report.status}<br>Loc: ${report.loc}`);
                    mapMarkers.push(circle);
                }
            });
        }

        function submitReport(e) {
            e.preventDefault();
            const newReport = {
                id: Date.now(),
                date: document.getElementById('r-date').value,
                name: document.getElementById('r-name').value,
                loc: document.getElementById('r-loc').value,
                diag: document.getElementById('r-diag').value,
                status: document.getElementById('r-status').value
            };
            reportList.unshift(newReport);
            saveData();
            refreshUI();
            e.target.reset();
            document.getElementById('r-date').valueAsDate = new Date();
            alert("‚úÖ Record Saved!");
        }

        function editStatus(id) {
            const index = reportList.findIndex(r => r.id === id);
            if(index === -1) return;
            const newStatus = prompt("Update Status (Critical, Stable, Recovered):", reportList[index].status);
            if(newStatus) {
                const s = newStatus.charAt(0).toUpperCase() + newStatus.slice(1).toLowerCase();
                if(['Critical', 'Stable', 'Recovered'].includes(s)) {
                    reportList[index].status = s;
                    saveData();
                    refreshUI();
                }
            }
        }

        function saveData() {
            localStorage.setItem('epiReports_v4', JSON.stringify(reportList));
        }

        // --- 7. EXPORT & VISUALS ---
        function downloadChartImage() {
            const canvas = document.getElementById('trendChart');
            const link = document.createElement('a');
            link.download = 'Monthly_Trend_Chart.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function downloadCSV() {
            if(reportList.length === 0) { alert("No data to export!"); return; }
            let csvContent = "data:text/csv;charset=utf-8,Date,Name,Location,Diagnosis,Status\n";
            reportList.forEach(row => {
                csvContent += `${row.date},${row.name},${row.loc},${row.diag},${row.status}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "EpiWatch_Data_Report.csv");
            document.body.appendChild(link);
            link.click();
        }

        function updateDashboard() {
            const activeCases = reportList.filter(r => r.status !== 'Recovered').length;
            document.getElementById('disp-active').innerText = activeCases;
            document.getElementById('disp-total').innerText = reportList.length;

            const criticalReports = reportList.filter(r => r.status === 'Critical');
            const criticalLocs = [...new Set(criticalReports.map(r => r.loc))]; 
            const zoneListEl = document.getElementById('zone-list');
            
            if (criticalLocs.length > 0) {
                zoneListEl.innerText = criticalLocs.join(', ');
                zoneListEl.style.color = "#b91c1c";
            } else {
                zoneListEl.innerText = "No Critical Zones";
                zoneListEl.style.color = "#166534";
            }
            updateChart();
        }

        function renderTable() {
            const tbody = document.getElementById('report-table-body');
            tbody.innerHTML = '';
            reportList.forEach(item => {
                const badgeClass = item.status === 'Critical' ? 'critical' : (item.status === 'Stable' ? 'stable' : 'recovered');
                tbody.innerHTML += `
                    <tr>
                        <td>${item.date}</td>
                        <td>${item.name}</td>
                        <td>${item.loc}</td>
                        <td><span class="badge ${badgeClass}">${item.status}</span></td>
                        <td><button class="btn-edit" onclick="editStatus(${item.id})">‚úèÔ∏è Edit</button></td>
                    </tr>
                `;
            });
        }

        function updateChart() {
            const ctx = document.getElementById('trendChart');
            const critical = reportList.filter(r => r.status === 'Critical').length;
            const stable = reportList.filter(r => r.status === 'Stable').length;
            const recovered = reportList.filter(r => r.status === 'Recovered').length;
            const dataValues = [critical, stable, recovered];

            const whiteBackground = {
                id: 'customCanvasBackgroundColor',
                beforeDraw: (chart) => {
                    const ctx = chart.canvas.getContext('2d');
                    ctx.save();
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, chart.width, chart.height);
                    ctx.restore();
                }
            };

            const dataLabelPlugin = {
                id: 'dataLabels',
                afterDatasetsDraw: (chart) => {
                    const { ctx } = chart;
                    chart.data.datasets.forEach((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);
                        meta.data.forEach((bar, index) => {
                            const value = dataset.data[index];
                            if(value > 0) {
                                ctx.fillStyle = '#475569';
                                ctx.font = 'bold 14px Segoe UI';
                                ctx.textAlign = 'center';
                                ctx.fillText(value, bar.x, bar.y - 10);
                            }
                        });
                    });
                }
            };

            if(trendChart) {
                trendChart.data.datasets[0].data = dataValues;
                trendChart.update();
            } else {
                trendChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Critical', 'Stable', 'Recovered'],
                        datasets: [{
                            label: 'Patient Status',
                            data: dataValues,
                            backgroundColor: ['#ef4444', '#f97316', '#10b981'],
                            borderRadius: 6
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        layout: { padding: { top: 20 } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                        plugins: { legend: { display: false } }
                    },
                    plugins: [whiteBackground, dataLabelPlugin]
                });
            }
        }
    </script>
</body>
</html>
